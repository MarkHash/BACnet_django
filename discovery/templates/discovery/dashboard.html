{% extends 'discovery/base.html' %}

{% block title %} Dashboard - BACnet Discovery{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>BACnet Device Discovery Dashboard</h1>
        <p class="text-muted">Discover and monitor BACnet devices on your network</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stats">
            <div class="card-body text-center">
                <h3 class="card-title">{{ total_devices }}</h3>
                <p class="card-text">Total Devices</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3 class="card-title">{{ online_devices }}</h3>
                <p class="card-text">Online Devices</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3 class="card-title">{{ total_points }}</h3>
                <p class="card-text">Total Points</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3 class="card-title" id="offline-count">{{ offline_devices }}</h3>
                <p class="card-text">Offline Devices</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5>Discovery Controls</h5>
            </div>
            <div class="card-body">
                <button id="discover-btn" class="btn btn-primary btn-lg me-3">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    üîç Discover Devices
                </button>

                <button id="clear-btn" class="btn btn-warning btn-lg me-3">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    üóëÔ∏è Clear All Devices
                </button>

                <button id="refresh-btn" class="btn btn-secondary btn-lg me-3">
                    üîÑ Refresh
                </button>

                <a href="{% url 'discovery:virtual_device_list' %}" class="btn btn-success btn-lg">
                    üñ•Ô∏è Manage Virtual Devices <span class="badge bg-secondary">Beta</span>
                </a>

                <div class="mt-3">
                    <small class="text-muted">
                        {% load tz %}
                        Last refresh: <span id="last-refresh">{% now "H:i:s" %}</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h5>Discovered Devices</h5>
                <span class="badge bg-primary">{{ devices|length }} devices</span>
            </div>
            <div class="card-body">
                {% if devices %}
                    <div class="row" id="devices-container">
                        {% for device in devices %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card device-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="online-indicator {% if device.is_online %}online {% else %}offline{% endif %}"></span>
                                        <h6 class="card-title mb-0">Device {{ device.device_id }}</h6>
                                    </div>

                                    <p class="card-text">
                                        <strong>Address:</strong> {{ device.address }}<br>
                                        <strong>Vendor ID:</strong> {{ device.vendor_id }}<br>
                                        <strong>Points:</strong>
                                        {% if device.points_read %}
                                            <span class="text-success">{{ device.point_count }} points</span>
                                        {% else %}
                                            <span class="text-muted">Not read</span>
                                        {% endif %}
                                    </p>

                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'discovery:device_detail' device.device_id %}" class="btn btn-outline-primary view-details-btn" data-device-id="{{ device.device_id }}" data-points-read="{{ device.points_read|yesno:'true,false' }}">
                                            üìã View Details
                                        </a>
                                        <!-- <button class="btn btn-outline-success read-points-btn" data-device-id="{{ device.device_id }}">
                                            üìñ Read Points
                                        </button> -->
                                    </div>

                                    <div class="mt-2">
                                        <small class="text-muted">
                                            {% load tz %}
                                            Last seen: {{ device.last_seen|timezone:"Australia/Melbourne"|date:"M d, H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-search" style="font-size: 3rem; color: #ccc;"></i>
                            </div>
                            <h5 class="text-muted">No devices discovered yet</h5>
                            <p class="text-muted">Click "Discover Devices" to start scanning your network</p>
                        </div>
                    {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('discover-btn').addEventListener('click', function() {
            const promise = apiCall(`/api/start-discovery/`, 'POST');
            handleButtonState(this, handleApiResponse(promise,
                () => reloadPageAfterDelay(),
                () => showAlert('Error starting discovery', 'danger')
            ));
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all devices? This cannot be undone.')) {
                const promise = apiCall(`/api/clear-devices/`, 'POST');
                handleApiResponse(promise, () => location.reload());
            }
        });

        document.getElementById('refresh-btn').addEventListener('click', function() {
            location.reload();
        });

        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const deviceId = this.dataset.deviceId;
                const pointsRead = this.dataset.pointsRead === 'true';
                console.log("pointsRead:", deviceId, pointsRead);

                if (!pointsRead) {
                    e.preventDefault();
                    const promise = apiCall(`/api/discover-points/${deviceId}/`, 'POST');
                    handleButtonState(this, handleApiResponse(promise,
                        () => {
                            showAlert('Points discovered! Redirecting...', 'success');
                            setTimeout(() => {
                                window.location.href = this.href + '?reading_points=true';
                                }, TIMEOUTS.REDIRECT_DELAY);
                            },
                        () => {
                            showAlert('Error loading points data', 'warning');
                            setTimeout(() => {
                                window.location.href = this.href + '?reading_points=true';
                            }, TIMEOUTS.REDIRECT_DELAY);
                        }
                    ),'‚è≥ Loading Points...');
                }
            });
        });

        document.querySelectorAll('.discover-points-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const deviceId = this.dataset.deviceId;
                const promise = apiCall(`/api/discover-points/${deviceId}/`, 'POST');
                handleButtonState(this, handleApiResponse(promise), '‚è≥ Reading...'
                );
            });
        });

        setInterval(() => {
            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
        }, TIMEOUTS.REFRESH_INTERVAL);

    });
</script>
{% endblock %}